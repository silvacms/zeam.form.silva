(function(e,t){var n=function(){var n=t(this),r=n.find("input.field-cropcoordinates"),i=n.find("a.widget-crop-popup-button"),s=n.find("div.widget-crop-popup").detach(),o=r.hasClass("field-required");e.ui.selection.disable(s),i.bind("click",function(n){var i=s.clone(),u=i.find("img.widget-crop-image"),a=u.get(0).width,f=u.get(0).height,l=Math.max(40+a,250),c=145+f,h=0,p=i.find("input.crop-proportional"),d=undefined;r.val()&&(d=r.val().replace(/^\s*(\d+)x(\d+)-(\d+)x(\d+)\s*$/,"$1,$2,$3,$4").split(","));var v=!1,m=undefined,g={aspectRatio:h,onSelect:function(e){d=[e.x,e.y,e.x2,e.y2]}},y=function(e){var n;e=t.extend({},g,e),m!==undefined&&m.destroy(),d!==undefined&&(e.setSelect=d),m=t.Jcrop(u,e)},b={Cancel:function(){i.dialog("close")},Clear:function(){r.val(""),i.dialog("close")},Ok:function(){d!==undefined&&(r.val(d[0]+"x"+d[1]+"-"+d[2]+"x"+d[3]),i.dialog("close"))}};o&&delete b.Clear,p.change(function(){m!==null&&(this.checked?h=a/f:h=0,m.setOptions({aspectRatio:h}))}),i.bind("dialogclose",function(){i.remove()}),i.bind("infrae-ui-dialog-resized",function(e,t){var n=t.width-40,r=t.height-145;if(n<a||r<f){var i=Math.min(n/a,r/f);y({boxWidth:i*a,boxHeight:i*f}),v=!0}else v&&(y(),v=!1)}),i.dialog({autoOpen:!1,modal:!0,width:l,height:c,open:y,buttons:b}),e.ui.ShowDialog(i,{minWidth:250,maxFactor:.9,maxWidth:l+10,maxHeight:c+10})})};t(".form-fields-container").live("loadwidget-smiform",function(e){t(this).find("div.widget-crop").each(n),e.stopPropagation()})})(infrae,jQuery);