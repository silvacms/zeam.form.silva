(function(infrae,$){var create_cropping_field=function(){var $field=$(this),$input=$field.find("input.field-cropcoordinates"),$opener=$field.find("a.widget-crop-popup-button"),$template=$field.find("div.widget-crop-popup").detach(),required=$input.hasClass("field-required");infrae.ui.selection.disable($template);var preload=new Image;preload.src=$template.data("image-url"),$opener.bind("click",function(){var $popup=$template.clone(),$img=$popup.find("img.widget-crop-image"),image_width=preload.width,image_height=preload.height,original_width=Math.max(40+image_width,250),original_height=145+image_height,ratio=0,$proportional=$popup.find("input.crop-proportional"),crop=void 0;$input.val()&&(crop=$input.val().replace(/^\s*(\d+)x(\d+)-(\d+)x(\d+)\s*$/,"$1,$2,$3,$4").split(","));var need_refresh=!1,jCrop=void 0,default_cropping_options={aspectRatio:ratio,onSelect:function(value){crop=[value.x,value.y,value.x2,value.y2]}},create_cropping=function(options){options=$.extend({},default_cropping_options,options),void 0!==jCrop&&jCrop.destroy(),void 0!==crop&&(options.setSelect=crop),jCrop=$.Jcrop($img,options)},actions={Cancel:function(){$popup.dialog("close")},Clear:function(){$input.val(""),$popup.dialog("close")},Ok:function(){void 0!==crop&&($input.val(crop[0]+"x"+crop[1]+"-"+crop[2]+"x"+crop[3]),$popup.dialog("close"))}};required&&delete actions.Clear,$proportional.change(function(){null!==jCrop&&(ratio=this.checked?image_width/image_height:0,jCrop.setOptions({aspectRatio:ratio}))}),$popup.bind("dialogclose",function(){$popup.remove()}),$popup.bind("infrae-ui-dialog-resized",function(event,popup_size){var candidate_width=popup_size.width-40,candidate_height=popup_size.height-145;if(image_width>candidate_width||image_height>candidate_height){var ratio=Math.min(candidate_width/image_width,candidate_height/image_height);create_cropping({boxWidth:ratio*image_width,boxHeight:ratio*image_height}),need_refresh=!0}else need_refresh&&(create_cropping(),need_refresh=!1)}),$popup.dialog({autoOpen:!1,modal:!0,width:original_width,height:original_height,open:create_cropping,buttons:actions}),infrae.ui.ShowDialog($popup,{minWidth:250,maxFactor:.9,maxWidth:original_width+10,maxHeight:original_height+10})})};$(document).on("loadwidget-smiform",".form-fields-container",function(event){$(this).find("div.widget-crop").each(create_cropping_field),event.stopPropagation()})})(infrae,jQuery);