(function($){$.widget("ui.multiselect",{options:{sortable:!0,searchable:!0,doubleClickable:!0,animated:"fast",show:"slideDown",hide:"slideUp",dividerLocation:.6,nodeComparator:function(node1,node2){var text1=node1.text(),text2=node2.text();return text1==text2?0:text2>text1?-1:1}},_create:function(){var that=this;this.element.hide(),this.id=this.element.attr("id"),this.count=0,this.container=$('<div class="ui-multiselect ui-helper-clearfix ui-widget"></div>'),this.selectedContainer=$('<div class="ui-multiselect-selected ui-multiselect-container"></div>').appendTo(this.container),this.availableContainer=$('<div class="ui-multiselect-available ui-multiselect-container"></div>').appendTo(this.container),this.selectedActions=$('<div class="ui-multiselect-actions ui-widget-header ui-helper-clearfix"><span class="count">0 '+$.ui.multiselect.locale.itemsCount+'</span><a href="#" class="remove-all">'+$.ui.multiselect.locale.removeAll+"</a></div>").appendTo(this.selectedContainer),this.availableActions=$('<div class="ui-multiselect-actions ui-widget-header ui-helper-clearfix"><input type="search" class="search empty ui-widget-content ui-corner-all"/><a href="#" class="add-all">'+$.ui.multiselect.locale.addAll+"</a></div>").appendTo(this.availableContainer),this.selectedList=$('<ul class="ui-multiselect-selected connected-list"><li class="ui-helper-hidden-accessible"></li></ul>').bind("selectstart",function(){return!1}).appendTo(this.selectedContainer),this.availableList=$('<ul class="ui-multiselect-available connected-list"><li class="ui-helper-hidden-accessible"></li></ul>').bind("selectstart",function(){return!1}).appendTo(this.availableContainer),this.options.animated||(this.options.show="show",this.options.hide="hide"),this._populateLists(this.element.find("option")),this.options.sortable&&this.selectedList.sortable({placeholder:"ui-state-highlight",axis:"y",update:function(){that.selectedList.find("li").each(function(){$(this).data("optionLink")&&$(this).data("optionLink").remove().appendTo(that.element)})},receive:function(event,ui){ui.item.data("optionLink").attr("selected",!0),that.count+=1,that._updateCount(),that.selectedList.children(".ui-draggable").each(function(){$(this).removeClass("ui-draggable"),$(this).data("optionLink",ui.item.data("optionLink")),$(this).data("idx",ui.item.data("idx")),that._applyItemState($(this),!0)}),setTimeout(function(){ui.item.remove()},1)}}),this.options.searchable?this._registerSearchEvents(this.availableContainer.find("input.search")):$(".search").hide(),this.container.find(".remove-all").click(function(){return that._populateLists(that.element.find("option").removeAttr("selected")),!1}),this.container.find(".add-all").click(function(){var options=that.element.find("option").not(":selected");return that.availableList.children("li:hidden").length>1?that.availableList.children("li").each(function(i){$(this).is(":visible")&&$(options[i-1]).attr("selected","selected")}):options.attr("selected","selected"),that._populateLists(that.element.find("option")),!1}),this.container.insertAfter(this.element)},destroy:function(){this.element.show(),this.container.remove(),$.Widget.prototype.destroy.apply(this,arguments)},_populateLists:function(options){this.selectedList.children(".ui-element").remove(),this.availableList.children(".ui-element").remove(),this.count=0;var that=this;$(options.map(function(i){var item=that._getOptionNode(this).appendTo(this.selected?that.selectedList:that.availableList).show();return this.selected&&(that.count+=1),that._applyItemState(item,this.selected),item.data("idx",i),item[0]})),this._updateCount(),that._filter.apply(this.availableContainer.find("input.search"),[that.availableList])},_updateCount:function(){this.selectedContainer.find("span.count").text(this.count+" "+$.ui.multiselect.locale.itemsCount)},_getOptionNode:function(option){option=$(option);var node=$('<li class="ui-state-default ui-element" title="'+option.text()+'"><span class="ui-icon"/>'+option.text()+'<a href="#" class="ui-multiselect-action"><span class="ui-corner-all ui-icon"/></a></li>').hide();return node.data("optionLink",option),node},_cloneWithData:function(clonee){var clone=clonee.clone(!1,!1);return clone.data("optionLink",clonee.data("optionLink")),clone.data("idx",clonee.data("idx")),clone},_setSelected:function(item,selected){if(item.data("optionLink").attr("selected",selected),selected){var selectedItem=this._cloneWithData(item);return item[this.options.hide](this.options.animated,function(){$(this).remove()}),selectedItem.appendTo(this.selectedList).hide()[this.options.show](this.options.animated),this._applyItemState(selectedItem,!0),selectedItem}var items=this.availableList.find("li"),comparator=this.options.nodeComparator,succ=null,i=item.data("idx"),direction=comparator(item,$(items[i]));if(direction){for(;i>=0&&items.length>i;)if(direction>0?i++:i--,direction!=comparator(item,$(items[i]))){succ=items[direction>0?i:i+1];break}}else succ=items[i];var availableItem=this._cloneWithData(item);return succ?availableItem.insertBefore($(succ)):availableItem.appendTo(this.availableList),item[this.options.hide](this.options.animated,function(){$(this).remove()}),availableItem.hide()[this.options.show](this.options.animated),this._applyItemState(availableItem,!1),availableItem},_applyItemState:function(item,selected){selected?(this.options.sortable?item.children("span").addClass("ui-icon-arrowthick-2-n-s").removeClass("ui-helper-hidden").addClass("ui-icon"):item.children("span").removeClass("ui-icon-arrowthick-2-n-s").addClass("ui-helper-hidden").removeClass("ui-icon"),item.find("a.ui-multiselect-action span").addClass("ui-icon-minus").removeClass("ui-icon-plus"),this._registerRemoveEvents(item.find("a.ui-multiselect-action"))):(item.children("span").removeClass("ui-icon-arrowthick-2-n-s").addClass("ui-helper-hidden").removeClass("ui-icon"),item.find("a.ui-multiselect-action span").addClass("ui-icon-plus").removeClass("ui-icon-minus"),this._registerAddEvents(item.find("a.ui-multiselect-action"))),this._registerHoverEvents(item)},_filter:function(list){var input=$(this),rows=list.children("li"),cache=rows.map(function(){return $(this).text().toLowerCase()}),term=$.trim(input.val().toLowerCase()),scores=[];term?(rows.hide(),cache.each(function(i){this.indexOf(term)>-1&&scores.push(i)}),$.each(scores,function(){$(rows[this]).show()})):rows.show()},_registerHoverEvents:function(elements){elements.removeClass("ui-state-hover"),elements.mouseover(function(){$(this).addClass("ui-state-hover")}),elements.mouseout(function(){$(this).removeClass("ui-state-hover")})},_registerAddEvents:function(elements){var that=this;elements.click(function(){return that._setSelected($(this).parent(),!0),that.count+=1,that._updateCount(),!1}),this.options.sortable&&elements.each(function(){$(this).parent().draggable({connectToSortable:that.selectedList,helper:function(){var selectedItem=that._cloneWithData($(this)).width($(this).width()-50);return selectedItem.width($(this).width()),selectedItem},appendTo:that.container,containment:that.container,revert:"invalid"})})},_registerRemoveEvents:function(elements){var that=this;elements.click(function(){return that._setSelected($(this).parent(),!1),that.count-=1,that._updateCount(),!1})},_registerSearchEvents:function(input){var that=this;input.focus(function(){$(this).addClass("ui-state-active")}).blur(function(){$(this).removeClass("ui-state-active")}).keypress(function(e){return 13==e.keyCode?!1:void 0}).keyup(function(){that._filter.apply(this,[that.availableList])}).bind("search",function(){that._filter.apply(this,[that.availableList])})}}),$.extend($.ui.multiselect,{locale:{addAll:"Add all",removeAll:"Remove all",itemsCount:"items selected"}})})(jQuery);