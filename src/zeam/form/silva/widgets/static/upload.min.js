(function(e){function t(e){return e.replace(/^.*[\/\\](.*)/,"$1")}var n={stat_url:"/gp.fileupload.stat/",stat_timeout:5e3,stat_delay:500,max_retries:3,errors:{too_many_retries:"unknown error while uploading file.",file_too_big:"upload failed file is too big."}},r=function(t,r){var i=e.Deferred(),s=0,o=0,u=Math.random()*1e19,a=null,f=null;r=e.extend({},n,r);var l=function(){a!==null&&(clearTimeout(a),a=null)},c=function(e){s!=e&&(s=e,t.progressbar("option","value",e))},h=function(e){l(),i.reject({filename:null,message:e})},p=function(e){switch(e.state){case-1:h(r.errors.file_too_big);break;case 0:o+=1;if(o>r.max_retries){h(r.errors.too_many_retries);return}t.show(),m();break;case 1:o=0,t.show(),e.percent>0&&c(e.percent),e.percent<100&&m();break;case 2:t.hide(),l()}},d=function(e,t,n){o+=1;if(o>r.max_retries){h(r.errors.too_many_retries);return}m()},v=function(){var t=r.stat_url+u;e.ajax({type:"GET",dataType:"json",timeout:r.stat_timeout,url:t,success:p,error:d})},m=function(){l(),a=setTimeout(v,r.stat_delay)};return{get_form:function(t,n){var r="?";return f=e('<form class="upload-form"enctype="multipart/form-data"method="POST"action=""target="'+t+'">'+'<input type="file" name="file" />'+"</form>"),n.match(/\?/)&&(r="&"),f.attr("action",n+r+"gp.fileupload.id="+u),f},send:function(){return f===null?null:(e(document).one("done-"+String(u)+"-upload",function(e,t){i.resolve({filename:t.path})}),f.submit(),m(),i.promise())}}},i=function(){var n=e(this),i=n.find("a.upload-trigger"),s=n.find("a.upload-clear"),o=n.find(".upload-progress"),u=n.find(".upload-input"),a=n.find(".upload-display"),f=u.val(),l=function(e){e.filename?a.text(t(e.filename)):e.message?a.text(e.message):a.text("not set."),u.val(e.filename),u.change()},c=function(){o.progressbar({value:0}),i.button("disable"),i.hide()},h=function(){o.hide(),i.button("enable"),i.show()};s.bind("click",function(){l("")}),i.bind("click",function(){var e=n.find("iframe"),t=n.find(".upload-popup").clone(),s=r(o),u=null;t.dialog({title:i.text(),modal:!0,create:function(){t.find("p").append(s.get_form(e.attr("name"),i.attr("href")))},autoOpen:!1,buttons:{Send:function(e){c(),u=s.send().fail(function(e){n.trigger("notify-feedback-smi",{message:e.message,category:"error"})}).always(function(e){l(e),h(),t.remove()}),t.dialog("close")}}}),t.bind("dialogclose",function(){u===null&&t.remove()}),t.dialog("open")})};e(".form-fields-container").live("loadwidget-smiform",function(t){e(this).find(".upload-file").each(i),t.stopPropagation()}),e(document).ready(function(){e(".upload-file").each(i)})})(jQuery);