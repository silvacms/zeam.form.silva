(function($){function basename(path){return path.replace(/^.*[\/\\](.*)/,"$1")}var default_options={stat_url:"/gp.fileupload.stat/",stat_timeout:5e3,stat_delay:500,max_retries:3,errors:{too_many_retries:"unknown error while uploading file.",file_too_big:"upload failed file is too big."}},FileUploader=function($progress,options){var deferred=$.Deferred(),progress_value=0,retries=0,upload_id=1e19*Math.random(),timeout=null,form=null;options=$.extend({},default_options,options);var clear_status=function(){null!==timeout&&(clearTimeout(timeout),timeout=null)},set_progress=function(value){progress_value!=value&&(progress_value=value,$progress.progressbar("option","value",value))},abort_upload=function(message){clear_status(),deferred.reject({filename:null,message:message})},poll_success=function(data){switch(data.state){case-1:abort_upload(options.errors.file_too_big);break;case 0:if(retries+=1,retries>options.max_retries)return abort_upload(options.errors.too_many_retries),void 0;$progress.show(),poll_status();break;case 1:retries=0,$progress.show(),data.percent>0&&set_progress(data.percent),100>data.percent&&poll_status();break;case 2:$progress.hide(),clear_status()}},poll_error=function(){return retries+=1,retries>options.max_retries?(abort_upload(options.errors.too_many_retries),void 0):(poll_status(),void 0)},_poll_status=function(){var url=options.stat_url+upload_id;$.ajax({type:"GET",dataType:"json",timeout:options.stat_timeout,url:url,success:poll_success,error:poll_error})},poll_status=function(){clear_status(),timeout=setTimeout(_poll_status,options.stat_delay)};return{get_form:function(target,action){var sep="?";return form=$('<form class="upload-form"enctype="multipart/form-data"method="POST"action=""target="'+target+'">'+'<input type="file" name="file" />'+"</form>"),action.match(/\?/)&&(sep="&"),form.attr("action",action+sep+"gp.fileupload.id="+upload_id),form},send:function(){return null===form?null:($(document).one("done-"+(upload_id+"")+"-upload",function(event,data){deferred.resolve({filename:data.path})}),form.submit(),poll_status(),deferred.promise())}}},create_upload_field=function(){var $field=$(this),$upload_button=$field.find("a.upload-trigger"),$clear_button=$field.find("a.upload-clear"),$progress=$field.find(".upload-progress"),$input=$field.find(".upload-input"),$status=$field.find(".upload-display");$input.val();var set_input_value=function(data){data.filename?$status.text(basename(data.filename)):data.message?$status.text(data.message):$status.text("not set."),$input.val(data.filename),$input.change()},disable_upload_button=function(){$progress.progressbar({value:0}),$upload_button.button("disable"),$upload_button.hide()},enable_upload_button=function(){$progress.hide(),$upload_button.button("enable"),$upload_button.show()};$clear_button.bind("click",function(){set_input_value("")}),$upload_button.bind("click",function(){var $iframe=$field.find("iframe"),$popup=$field.find(".upload-popup").clone(),uploader=FileUploader($progress),promise=null;$popup.dialog({title:$upload_button.text(),modal:!0,create:function(){$popup.find("p").append(uploader.get_form($iframe.attr("name"),$upload_button.attr("href")))},autoOpen:!1,zIndex:12500,buttons:{Send:function(){disable_upload_button(),promise=uploader.send().fail(function(data){$field.trigger("notify-feedback-smi",{message:data.message,category:"error"})}).always(function(data){set_input_value(data),enable_upload_button(),$popup.remove()}),$popup.dialog("close")}}}),$popup.bind("dialogclose",function(){null===promise&&$popup.remove()}),$popup.dialog("open")})};$(".form-fields-container").live("loadwidget-smiform",function(event){$(this).find(".upload-file").each(create_upload_field),event.stopPropagation()}),$(document).ready(function(){$(".upload-file").each(create_upload_field)})})(jQuery);