(function($,infrae){var create_validator=function(){var $field=$(this);if(!$field.hasClass("form-novalidation")&&!$field.closest(".field-object").length){var $form=$field.closest("form"),field_prefix=$field.attr("data-field-prefix"),form_prefix=$form.attr("name"),form_url=$form.attr("data-form-url");if(form_url){var find_sub_field=function(selector){return $field.is(selector)?$field.children("div.form-field"):$field.find(selector).children("div.form-field")};$field.delegate(".field","change",function(){setTimeout(function(){var values=[{name:"prefix.field",value:field_prefix},{name:"prefix.form",value:form_prefix}],serialize_field=function(){var $input=$(this);if(!$input.is(":checkbox")&&!$input.is(":radio")||$input.is(":checked")){var value=$input.val();if(null!==value){$.isArray(value)||(value=[value]);for(var i=value.length;i>0;i--)values.push({name:$input.attr("name"),value:value[i-1]})}}};$field.find("input").each(serialize_field),$field.find("textarea").each(serialize_field),$field.find("select").each(serialize_field),$.ajax({url:form_url+"/++rest++zeam.form.silva.validate",type:"POST",dataType:"json",data:values,success:function(data){var key,errors=data.errors;if($field.find(".form-error-message").remove(),data.success)return $field.removeClass("form-error"),void 0;if($field.addClass("form-error"),errors)for(key in errors)find_sub_field('div[data-field-prefix="'+key+'"]').after('<div class="form-error-message"><div class="form-error-detail"><p>'+errors[key]+"</p></div></div>")}})},0)})}}};$(document).bind("load-smiplugins",function(event,smi){var Popup=function($popup,extra_array){var popup={},close=$.Deferred(),closing=!1,$form=null,cleanup_form=function(){null!==$form&&($form.trigger("clean-smiform",{form:$form,container:$form,popup:$popup}),$form.remove(),$form=null)},create_callback=function(form_url,data){var action_label=data.label,action_name=data.name,action_type=data.action;return function(){switch(action_type){case"send":case"close_on_success":$form.trigger("serialize-smiform",{form:$form,container:$form,popup:$popup});var form_data=$form.serializeArray();form_data.push({name:action_name,value:action_label}),void 0!==extra_array&&(form_data=form_data.concat(extra_array)),smi.ajax.query(form_url,form_data).then(function(data){return infrae.interfaces.is_implemented_by("popup",data)?"close_on_success"==action_type&&data.success?popup.close(data):$.when(popup.from_data(data)).then(function($form){return infrae.ui.ResizeDialog($popup),$form}):popup.close(data).done(function(data){return $(document).render({data:data,args:[smi]})})},function(){popup.close({})});break;case"close":popup.close({})}return!1}};return $popup.dialog({autoOpen:!1,modal:!0,width:800}),$popup.bind("dialogclose",function(){cleanup_form(),$popup.remove(),closing===!1&&close.reject({})}),$popup.delegate("a.open-screen","click",function(){$popup.dialog("close")}),$.extend(popup,{display:function(builder){return $.when(builder).then(function(){return infrae.ui.ShowDialog($popup,{maxFactor:.8}),popup},function(request){return $.Deferred().reject(request)})},close:function(data){return closing=!0,$popup.dialog("close"),close.resolve(data)},promise:function(){return close.promise()},from_url:function(url){return smi.ajax.query(url).then(function(data){return infrae.interfaces.is_implemented_by("popup",data)?popup.from_data(data):popup.close(data)},function(request){return closing=!0,$popup.dialog("close"),close.reject(request)})},from_data:function(data){var buttons={},submit_url=data.submit_url||data.url;cleanup_form(),$form=$('<form class="form-content form-fields-container" />'),$form.attr("data-form-url",data.url),data.validation||$form.attr("data-form-novalidation","true"),$form.attr("name",data.prefix),$form.html(data.widgets),$form.append('<input type="submit" style="display: none" />'),$popup.dialog("option","title",data.label),$popup.append($form);for(var i=0;data.actions.length>i;i++){var label=data.actions[i].label,callback=create_callback(submit_url,data.actions[i]);buttons[label]=callback,data.actions[i].name==data["default"]&&$form.bind("submit",callback)}return $popup.dialog("option","buttons",buttons),$form.trigger("load-smiform",{form:$form,container:$form,popup:$popup}),$form}}),popup};$.fn.SMIFormPopup=function(options){var $popup=$("<div></div>"),url=void 0;options=$.extend(options,{}),url=void 0!==options.url?options.url:$(this).attr("href");var popup=Popup($popup,options.payload),builder=null;return builder=infrae.interfaces.is_implemented_by("popup",options)?popup.from_data(options):popup.from_url(url),popup.display(builder)},infrae.views.view({iface:"popup",factory:function($content,data){return $content.SMIFormPopup(data)}})}),$(document).on("addline-zeamform",".field-collection-line",function(){var $line=$(this);$line.addClass("form-fields-container"),$line.trigger("loadwidget-smiform")}),$(document).on("loadwidget-smiform",".form-fields-container",function(event){$(this).find("div.field-collection").each(function(){void 0!==$(this).ZeamCollectionWidget&&$(this).ZeamCollectionWidget()}),event.stopPropagation()});var bootstrap_form=function(){var $form=$(this);$form.find(".zeam-select-all").bind("change",function(){var $select=$(this),status=$select.attr("checked");$form.find("."+$select.attr("name")).each(function(){status?$(this).attr("checked",status):$(this).removeAttr("checked")})}),$form.is("form")&&!$form.data("form-novalidation")&&$form.find(".form-section").each(create_validator),$form.find("form").each(function(){var $form=$(this);$form.data("form-novalidation")||$form.find(".form-section").each(create_validator)})};$(document).on("load-smiform",".form-content",bootstrap_form),$(document).ready(function(){$(".form-content").each(bootstrap_form),$(document).on("click",".form-popup",function(){return $(this).SMIFormPopup(),!1})})})(jQuery,infrae);